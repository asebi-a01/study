# Postfix のアーキテクチャ

このドキュメントでは、Postfix メールシステムのアーキテクチャについて説明します。

## はじめに

Postfix は、柔軟で強力なメール転送エージェント（MTA）です。モジュラーアーキテクチャを採用しており、小さなプログラムの集合体が連携してメールの処理と配送を行います。各プログラムは特定の目的を持っており、これによりセキュリティと堅牢性が向上しています。

Postfix の主な構成要素は以下の通りです。

-   **デーモン**: メールの受信、配送、キューの管理などのタスクを処理する、長時間実行されるサーバープロセスです。
-   **キュー**: Postfix は、処理のさまざまな段階でメールを管理するために、複数のキューを使用します。
-   **コマンド**: サービスの開始/停止、キューの表示、設定の管理など、Postfix を管理するためのコマンドラインユーティリティです。

## Postfix がメールを受信する方法

メッセージが Postfix システムに入ると、いくつかのステップを経由します。

```
                                trivial-rewrite(8)
                                        ^
                                        |
ネットワーク -> smtpd(8) |
        ^                               v
        | \
ネットワーク -> qmqpd(8) -> cleanup(8) -> incoming キュー
        | /
        pickup(8) <- maildrop キュー
        ^
        |
ローカル -> sendmail(1) -> postdrop(1)
```

1.  **ネットワークからの受信**:
    *   `smtpd(8)` デーモンは、SMTP プロトコルを使用してネットワークからの受信メールを待ち受けます。
    *   悪意のあるクライアントからシステムを保護するための初期チェックを行い、メールを `cleanup(8)` デーモンに渡します。

2.  **ローカルからの投入**:
    *   ローカルユーザーは `sendmail(1)` コマンドを使用してメールを投入できます。
    *   `postdrop(1)` コマンドは、メールを `maildrop` キューに配置します。
    *   `pickup(8)` デーモンは `maildrop` キューからメールを読み取り、`cleanup(8)` デーモンに渡します。

3.  **クリーンアップ**:
    *   `cleanup(8)` デーモンは、メールがキューに入れられる前の最終処理を行います。
    *   不足しているヘッダー（`From:`など）を追加し、アドレスを変換し、オプションでコンテンツフィルタリングを実行します。
    *   クリーンアップされたメッセージは `incoming` キューに配置されます。

4.  **アドレス書き換え**:
    *   `trivial-rewrite(8)` デーモンは、アドレスを標準の `user@fully.qualified.domain` 形式に解決します。

## Postfix がメールを配送する方法

メッセージが `incoming` キューに到達すると、キューマネージャー（`qmgr(8)`）が配送を引き継ぎます。

```
                                trivial-rewrite(8)     smtp(8) -> ネットワーク
                                        /               ^
                                        |               |
                                        v               |
                                      - lmtp(8) -> ネットワーク
                                     /
incoming -> active -> qmgr(8) --- local(8) -> ファイル, コマンド
        ^       |               |               \
        |       |               |                - virtual(8) -> ファイル
        |       deferred <------+
        |                                        \
        +----------------------------------------- pipe(8) -> コマンド
```

1.  **キューマネージャー**:
    *   `qmgr(8)` デーモンは、Postfix の配送の中心です。
    *   メッセージを `incoming` キューから `active` キューに移動して、即時配送します。
    *   配送に失敗した場合、メッセージは後で再試行するために `deferred` キューに移動されます。
    *   キューマネージャーは、各受信者に対して適切な配送エージェント（`smtp`、`local`など）に連絡します。

2.  **配送エージェント**:
    *   **`smtp(8)`**: SMTP を使用して、ネットワーク上の他のサーバーにメールを配送します。
    *   **`lmtp(8)`**: LMTP プロトコルを使用して、ローカルのメッセージストアにメールを配送します。
    *   **`local(8)`**: ローカルユーザーのメールボックス（例：`/var/spool/mail/username`）にメールを配送します。`procmail` などの外部コマンドに配送することもできます。
    *   **`virtual(8)`**: バーチャルドメインのメールをメールボックスに配送します。
    *   **`pipe(8)`**: メールを外部コマンドに配送します。

## Postfix の舞台裏

他のいくつかのプロセスがバックグラウンドで動作し、主要な機能をサポートしています。

*   **`master(8)`**: マスターデーモンは、Postfix システム全体のスーパーバイザーです。必要に応じて他のデーモンを起動および停止し、クラッシュした場合は再起動します。
*   **`anvil(8)`**: `smtpd` クライアントのレート制限を提供し、乱用を防ぎます。
*   **`bounce(8)`, `defer(8)`, `trace(8)`**: これらのデーモンは、不達通知（バウンス）と遅延メール通知を処理します。
*   **`flush(8)`**: 特定の宛先の `deferred` キューからのメール配信を強制します。
*   **`proxymap(8)`**: 他の Postfix プロセスに読み取り専用および読み書き可能なテーブル検索サービスを提供します。
*   **`scache(8)`**: `smtp` クライアントの接続キャッシュを管理し、パフォーマンスを向上させます。
*   **`tlsmgr(8)`**: 安全な通信のために TLS（SSL）セッションを管理します。
*   **`verify(8)`**: 送信者または受信者のアドレスが受け入れられる前に、配送可能であることを確認します。
*   **`postscreen(8)`**: `smtpd` デーモンと通信する前に、既知のスパムソースをブロックするプレフィルターです。

## Postfix サポートコマンド

Postfix には、管理用のさまざまなコマンドラインツールが含まれています。

*   **`postfix(1)`**: メールシステムを制御するためのメインコマンド（開始、停止、リロードなど）。
*   **`postconf(1)`**: `main.cf` の Postfix 設定パラメーターを表示および編集します。
*   **`postqueue(1)`**: メールキューを管理します（一覧表示、フラッシュなど）。
*   **`postsuper(1)`**: メッセージの削除など、キューのメンテナンスタスクを実行します。
*   **`postmap(1)`**: エイリアスやバーチャルドメインなどのルックアップテーブルを作成および管理します。
*   **`postalias(1)`**: エイリアスデータベースを作成または更新します。
*   **`mailq(1)`**: `postqueue -p` の同義語で、メールキューを一覧表示します。
*   **`newaliases(1)`**: `postalias` の同義語で、エイリアスデータベースを再構築します。
