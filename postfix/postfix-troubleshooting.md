# Postfix のトラブルシューティング

このドキュメントでは、Red Hat ベースのシステムで Postfix メールサーバーに関する一般的な問題のトラブルシューティングのガイダンスを提供します。

## 一般的なトラブルシューティング手順

問題が発生した場合は、これらの基本的な手順から始めます。

1.  **メールログを確認する**: Postfix のトラブルシューティングで最も重要なステップは、メールログを確認することです。Red Hat システムでは、通常 `/var/log/maillog` です。
    ```bash
    sudo tail -f /var/log/maillog
    ```
    `error`、`warning`、`fatal`、`panic`、`reject`、`bounce` などのキーワードを探します。

2.  **Postfix の状態を確認する**: Postfix サービスが実行されていることを確認します。
    ```bash
    sudo postfix status
    ```

3.  **設定を確認する**: `postfix check` を実行して、ファイルのパーミッションや所有権に明らかなエラーがないか確認します。
    ```bash
    sudo postfix check
    ```
    また、`/etc/postfix/main.cf` と `/etc/postfix/master.cf` への最近の変更を確認します。`postconf -n` を使用して、デフォルト以外のすべてのパラメータを表示します。

4.  **メールキューを確認する**: メールキューを調べて、メッセージが滞留していないか確認します。
    ```bash
    mailq
    ```
    出力には、キューID、送信者、受信者、および遅延メールのエラーメッセージが表示されます。

## 一般的な問題と解決策

### メールが送信されない（アウトバウンドの問題）

-   **症状**: メールがキューに留まり、最終的にタイムアウトします。
-   **考えられる原因と解決策**:
    -   **ファイアウォール**: サーバーのファイアウォールがポート 25 での送信接続をブロックしている可能性があります。また、ISP やクラウドプロバイダーがデフォルトでこのポートをブロックしている場合があります。
    -   **DNS 解決**: サーバーが受信者のドメインを解決できません。`dig` または `nslookup` を使用して DNS をテストします。
        ```bash
        dig mx example.com
        ```
    -   **不正な `relayhost`**: スマートホスト（`relayhost`）を使用している場合は、ホスト名が正しいこと、および MX ルックアップを防ぐために角括弧で囲んでいること（例：`[smtp.example.com]`）を確認してください。また、リレーホストが認証を必要とするかどうかも確認してください。

### メールが受信されない（インバウンドの問題）

-   **症状**: 外部の送信者が「接続が拒否されました」または「接続がタイムアウトしました」というエラーを受け取ります。メールが届きません。
-   **考えられる原因と解決策**:
    -   **ファイアウォール**: ファイアウォールがポート 25 での受信接続をブロックしています。
    -   **Postfix がリッスンしていない**: `main.cf` の `inet_interfaces` が正しく設定されていること（例：`all` または特定の IP アドレス）を確認します。
    -   **DNS MX レコード**: パブリック DNS のドメインの MX レコードが、メールサーバーの正しい IP アドレスを指している必要があります。外部ツール（`mxtoolbox.com` など）を使用して確認します。

### "Relay access denied"（リレーアクセスが拒否されました）

-   **症状**: ローカルネットワーク上のユーザーまたはリモートクライアントが外部ドメインにメールを送信できません。ログに `Relay access denied` と表示されます。
-   **原因**: クライアントの IP アドレスが `mynetworks` にリストされていません。
-   **解決策**: `main.cf` の `mynetworks` パラメータにクライアントの IP アドレスまたはネットワーク範囲を追加します。リモートユーザーの場合は、IP アドレスを追加する代わりに SMTP 認証（SASL）を設定する必要があります。
    ```
    # main.cf
    mynetworks = 127.0.0.0/8, 192.168.1.0/24
    ```

### "Mail for example.com loops back to myself"（example.com のメールが自分自身にループバックします）

-   **症状**: ローカルドメインに送信されたメールがこのエラーでバウンスされます。
-   **原因**: これは、サーバーが（DNS によると）ドメインの MX ホストであるが、そのドメインのメールを受け入れるように設定されていない場合に発生します。
-   **解決策**: `main.cf` の `mydestination` パラメータにドメイン名を追加します。
    ```
    # main.cf
    mydestination = $myhostname, localhost.$mydomain, localhost, example.com
    ```
    サーバーが NAT の内側にある場合は、`proxy_interfaces` パラメータを NAT デバイスのパブリック IP アドレスに設定する必要がある場合があります。

### "Host or domain name not found"（ホストまたはドメイン名が見つかりません）

-   **症状**: メールがこのエラーでバウンスされます。
-   **原因**: Postfix が受信者のドメインの DNS レコード（A または MX）を見つけられません。
-   **解決策**: これは通常、受信者のドメイン名のタイプミスか、受信者の DNS 設定の問題です。通常、サーバー側でこれを修正するためにできることは何もありませんが、`dig` または `nslookup` を使用して問題を確認できます。

### "Connection timed out"（接続がタイムアウトしました）

-   **症状**: メールが `deferred` キューに留まり、ログに接続タイムアウトが表示されます。
-   **原因**: これはネットワークの問題です。サーバーがポート 25 で受信者のメールサーバーへの接続を確立できません。
-   **解決策**:
    -   サーバーからのネットワーク接続を確認します（`ping`、`traceroute`）。
    -   ファイアウォールがポート 25 での送信接続を許可していることを確認します。
    -   リモートサーバーがダウンしているか、一時的に利用できない可能性があります。Postfix は後で自動的に再試行します。

### メールが `deferred` キューで遅延している

-   **症状**: メッセージがすぐに配信されず、`deferred` キューにリストされます。
-   **原因**: 受信者のサーバーが一時的にオフラインである、ビジーである、またはサーバーをグレイリスティングしている可能性があります。
-   **解決策**: これは通常、一時的な問題です。Postfix には組み込みのバックオフメカニズムがあり、間隔を空けて配信を再試行します。`mailq` の出力で遅延の理由を確認できます。問題が長期間続く場合は、特定のエラーメッセージを調査してください。`sudo postfix flush` を実行して、即時再試行を強制できます。
