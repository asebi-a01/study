# Postfix 総合ガイド

このドキュメントは、Red Hat ベースの Linux OS にインストールされた Postfix メール転送エージェント（MTA）の動作について、アーキテクチャ、設定、コマンド、トラブルシューティングの観点から統合的に解説します。

---

## 第1章: Postfix のアーキテクチャ

### 1.1 はじめに

Postfix は、柔軟で強力なメール転送エージェント（MTA）です。モジュラーアーキテクチャを採用しており、小さなプログラムの集合体が連携してメールの処理と配送を行います。各プログラムは特定の目的を持っており、これによりセキュリティと堅牢性が向上しています。

Postfix の主な構成要素は以下の通りです。

-   **デーモン**: メールの受信、配送、キューの管理などのタスクを処理する、長時間実行されるサーバープロセスです。
-   **キュー**: Postfix は、処理のさまざまな段階でメールを管理するために、複数のキューを使用します。
-   **コマンド**: サービスの開始/停止、キューの表示、設定の管理など、Postfix を管理するためのコマンドラインユーティリティです。

### 1.2 Postfix がメールを受信する方法

メッセージが Postfix システムに入ると、いくつかのステップを経由します。

```
                                trivial-rewrite(8)
                                        ^
                                        |
ネットワーク -> smtpd(8) |
        ^                               v
        | \
ネットワーク -> qmqpd(8) -> cleanup(8) -> incoming キュー
        | /
        pickup(8) <- maildrop キュー
        ^
        |
ローカル -> sendmail(1) -> postdrop(1)
```

1.  **ネットワークからの受信**: `smtpd(8)` デーモンが SMTP プロトコルでメールを待ち受け、初期チェックの後 `cleanup(8)` デーモンに渡します。
2.  **ローカルからの投入**: ローカルユーザーが `sendmail(1)` で投入したメールは `postdrop(1)` によって `maildrop` キューに置かれ、`pickup(8)` がそれを拾って `cleanup(8)` に渡します。
3.  **クリーンアップ**: `cleanup(8)` デーモンがヘッダーの追加やアドレス変換を行い、`incoming` キューにメッセージを配置します。
4.  **アドレス書き換え**: `trivial-rewrite(8)` デーモンがアドレスを `user@fully.qualified.domain` 形式に正規化します。

### 1.3 Postfix がメールを配送する方法

`incoming` キューのメッセージは、キューマネージャー（`qmgr(8)`）によって配送されます。

```
                                trivial-rewrite(8)     smtp(8) -> ネットワーク
                                        /               ^
                                        |               |
                                        v               |
                                      - lmtp(8) -> ネットワーク
                                     /
incoming -> active -> qmgr(8) --- local(8) -> ファイル, コマンド
        ^       |               |               \
        |       |               |                - virtual(8) -> ファイル
        |       deferred <------+
        |                                        \
        +----------------------------------------- pipe(8) -> コマンド
```

1.  **キューマネージャー (`qmgr(8)`)**: 配送の中心であり、`incoming` キューから `active` キューにメッセージを移し、適切な配送エージェントに配送を依頼します。失敗したメールは `deferred` キューで再試行を待ちます。
2.  **配送エージェント**:
    *   `smtp(8)`: 他のメールサーバーへ SMTP で配送します。
    *   `local(8)`: ローカルユーザーのメールボックスに配送します。
    *   `virtual(8)`: バーチャルドメインのメールボックスに配送します。
    *   `pipe(8)`: 外部コマンドにメールを渡します。

### 1.4 Postfix の舞台裏

その他、以下のデーモンがバックグラウンドでシステムを支えています。

*   `master(8)`: 全ての Postfix デーモンを監督するマスタープロセス。
*   `anvil(8)`: クライアントの接続レートを制限し、乱用を防ぎます。
*   `bounce(8)`, `defer(8)`: 不達・遅延メールの通知を管理します。
*   `postscreen(8)`: `smtpd` の前段で、既知のスパム送信元をブロックします。

---

## 第2章: Postfix の設定

### 2.1 設定ファイル

Red Hat システムでは、Postfix の設定ファイルは `/etc/postfix` にあります。

-   `main.cf`: Postfix のメイン設定ファイル。システムの動作を制御する主要なパラメータを定義します。
-   `master.cf`: `master` デーモンが各サービスをどのように実行するかを定義します。

設定変更後は、`sudo postfix reload` でリロードが必要です。

### 2.2 `main.cf` の主要な設定

#### サーバーの識別情報
-   `myhostname`: メールサーバーの FQDN (例: `mail.example.com`)。
-   `mydomain`: サーバーが属するドメイン (例: `example.com`)。
-   `myorigin`: 送信メールの `From:` ヘッダーに使われるドメイン。通常は `$mydomain` を指定します。

#### メールの受信設定
-   `mydestination`: このサーバーがローカル配送するドメインのリスト。
-   `inet_interfaces`: メールを待ち受けるネットワークインターフェース。通常は `all` を指定します。
-   `mynetworks`: メールの中継（リレー）を許可する、信頼できるクライアントのIPアドレスやネットワーク範囲。

#### メールの送信設定
-   `relayhost`: 全ての送信メールを経由させる外部のスマートホスト。ISPのサーバーなどを指定します (例: `[smtp.isp.com]`)。

#### メールボックス設定
-   `home_mailbox`: ユーザーのホームディレクトリを基準としたメールボックスの場所。`Maildir/` 形式が推奨されます。

### 2.3 その他の重要なファイル
-   `/etc/aliases`: メールエイリアスの定義ファイル。編集後は `newaliases` コマンドの実行が必要です。
-   **ルックアップテーブル**: `virtual_alias_maps` など、バーチャルドメインやアクセスコントロールに使用するデータベースファイル。`postmap` コマンドで作成します。

---

## 第3章: Postfix の管理コマンド

### 3.1 サービス管理 (`postfix`)
-   `sudo postfix start`: サービスの開始。
-   `sudo postfix stop`: サービスの停止。
-   `sudo postfix reload`: 設定の再読み込み。
-   `sudo postfix status`: 状態の確認。
-   `sudo postfix check`: 設定の構文や権限のチェック。

### 3.2 キュー管理
-   `mailq` (または `postqueue -p`): メールキューの一覧表示。
-   `sudo postsuper -d QUEUE_ID`: キューから特定のメールを削除。
-   `sudo postsuper -d ALL deferred`: 遅延キュー内の全メールを削除。
-   `sudo postsuper -h QUEUE_ID`: 特定のメールを保留状態にする。
-   `sudo postsuper -H QUEUE_ID`: 保留状態のメールを解放する。
-   `sudo postfix flush` (または `postqueue -f`): キュー内の全メールの再配送を試みる。

### 3.3 設定管理 (`postconf`)
-   `postconf -n`: デフォルトから変更された設定のみ表示。
-   `sudo postconf -e "parameter=value"`: `main.cf` のパラメータを更新。

### 3.4 ルックアップテーブル管理
-   `sudo postmap /etc/postfix/transport`: テキストファイルから `.db` ファイルを生成。
-   `sudo newaliases`: `/etc/aliases` からエイリアスDBを再構築。

---

## 第4章: トラブルシューティング

### 4.1 基本的なトラブルシューティング手順
1.  **メールログを確認する**: 最も重要な情報源です。Red Hat系では `/var/log/maillog` を確認します。`sudo tail -f /var/log/maillog` でリアルタイムに監視します。
2.  **Postfix の状態を確認する**: `sudo postfix status` でサービスが起動しているか確認します。
3.  **設定を確認する**: `sudo postfix check` で設定の不備を確認します。
4.  **メールキューを確認する**: `mailq` でメールが滞留していないか、エラーメッセージは何かを確認します。

### 4.2 ログステータスの詳細: `bounced` と `deferred`
-   **`status=deferred` (一時的な失敗)**: 後で再試行される一時的なエラー。
    -   **原因**: 接続タイムアウト、グレイリスティング、相手サーバーの一時的なエラーなど。
    -   **解決策**: 多くは時間をおけば解決します。長引く場合はエラーメッセージを元にネットワークや相手サーバーの状態を調査します。
-   **`status=bounced` (恒久的な失敗)**: 配送に失敗し、送信者に不達通知が返される恒久的なエラー。
    -   **原因**: 宛先ユーザー不明、ドメイン名が見つからない、メール転送ループ、ポリシーによる拒否など。
    -   **解決策**: ログのエラーメッセージを正確に読み解き、アドレスや設定の誤りを修正するか、相手先の管理者に連絡します。

### 4.3 よくある問題と解決策

-   **メールが送信されない**:
    -   **症状**: メールがキューに滞留し、タイムアウトする。
    -   **解決策**: ファイアウォール（Port 25）の確認、DNS解決の確認 (`dig mx example.com`)、`relayhost` 設定の確認。

-   **メールが受信されない**:
    -   **症状**: 外部からメールが届かない。
    -   **解決策**: ファイアウォールの確認、`inet_interfaces` 設定の確認、DNSのMXレコードの確認。

-   **"Relay access denied"**:
    -   **症状**: ローカルネットワークのクライアントが外部にメールを送れない。
    -   **解決策**: `mynetworks` にクライアントのIPアドレス範囲が正しく設定されているか確認します。リモートクライアントはSASL認証を設定するのが適切です。

-   **"Mail for example.com loops back to myself"**:
    -   **症状**: 自ドメイン宛のメールがバウンスする。
    -   **解決策**: サーバーが `example.com` のMXホストであるにもかかわらず、そのドメインをローカル配送する設定 (`mydestination` など) がない場合に発生します。`mydestination` にドメインを追加します。

-   **"Connection timed out"**:
    -   **症状**: 相手サーバーへの接続がタイムアウトする。
    -   **解決策**: ネットワーク接続、ファイアウォールを確認します。相手サーバーが一時的にダウンしている可能性もあります。
